# BE-019: Фільтрація звернень для виконавців по категоріях

Фаза: 1 (MVP - розширення)
Тип: Backend

## Мета
Реалізувати обмеження видимості звернень для виконавців на основі доступу до категорій.

## Скоуп
- Розширення правил доступу для EXECUTOR (доповнення до BE-016):
  - Виконавець бачить тільки ті звернення, які належать до категорій, до яких у нього є доступ
  - Якщо у виконавця немає жодного доступу до категорій - він не бачить жодних звернень
  - Якщо у виконавця є доступ до категорії - він бачить:
    - Всі нові звернення цієї категорії (статус "Нове")
    - Всі звернення цієї категорії, де він є відповідальним
  
- Модифікація ендпоінтів:
  - GET /cases - додати фільтрацію по категоріях для EXECUTOR
    - Джоін з ExecutorCategoryAccess для отримання дозволених категорій
    - Фільтр: category_id IN (дозволені категорії)
  - PATCH /cases/{public_id}/status - додати перевірку доступу до категорії
    - Перед зміною статусу перевірити, що виконавець має доступ до категорії звернення
  
- Правила зміни статусів (доповнення до BE-016):
  - Виконавець може змінювати статус тільки тих звернень, до категорій яких у нього є доступ
  - При спробі змінити статус звернення з недоступної категорії - повертати 403
  
- Логування:
  - При спробі доступу до звернення з недоступної категорії - логувати подію
  
## Необхідні зміни API
- GET /cases - модифікація фільтрації для EXECUTOR:
  - Додати джоін з executor_category_access
  - Фільтр по дозволених категоріях
- PATCH /cases/{public_id}/status - додати перевірку доступу до категорії
- GET /cases/{public_id} - додати перевірку доступу до категорії для EXECUTOR

## Вимоги/обмеження
- Фільтрація на рівні ORM запитів (не пост-обробка)
- Оптимізація запитів (уникати N+1)
- ADMIN та OPERATOR не підпадають під обмеження по категоріях
- При відсутності доступів у виконавця - повертати порожній список
- Чіткі помилки 403 з описом причини (немає доступу до категорії)

## Визначення готовності (DoD)
- GET /cases для EXECUTOR повертає тільки звернення з дозволених категорій
- EXECUTOR не може переглянути звернення з недоступної категорії (403)
- EXECUTOR не може змінити статус звернення з недоступної категорії (403)
- Виконавець без доступів до категорій бачить порожній список
- ADMIN бачить всі звернення (без обмежень)
- OPERATOR бачить всі нові звернення (без обмежень по категоріях)
- Запити оптимізовані, без N+1 проблем

## Тести
- EXECUTOR з доступом до категорії "Медичні послуги" бачить звернення цієї категорії
- EXECUTOR не бачить звернення з категорії, до якої немає доступу
- EXECUTOR з доступом до кількох категорій бачить звернення всіх дозволених категорій
- EXECUTOR без доступів до категорій отримує порожній список
- EXECUTOR намагається змінити статус звернення з недоступної категорії (403)
- EXECUTOR успішно змінює статус звернення з доступної категорії
- EXECUTOR намагається переглянути деталі звернення з недоступної категорії (403)
- ADMIN бачить всі звернення незалежно від категорій
- OPERATOR бачить всі нові звернення незалежно від категорій
- Продуктивність запитів (перевірка explain для великих обсягів)

## Залежності
- BE-016 (правила доступу виконавця)
- BE-018 (модель доступу до категорій)
- BE-003 (модель Category)
- BE-007 (управління статусами)

## Позначки
- RBAC, Permissions, Category Access, Executor, Filtering, Access Control

