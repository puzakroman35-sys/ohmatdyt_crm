# BE-020: Профіль користувача - зміна власного пароля

Фаза: 1 (MVP - розширення)
Тип: Backend

## Мета
Надати можливість будь-якому авторизованому користувачу змінити свій власний пароль.

## Скоуп
- Новий ендпоінт для зміни власного пароля:
  - POST /api/auth/change-password
  - Доступний для всіх авторизованих користувачів (OPERATOR, EXECUTOR, ADMIN)
  - Потребує поточного пароля для підтвердження особи
  - Приймає новий пароль з підтвердженням
  
- Request Body:
  ```json
  {
    "current_password": "string",
    "new_password": "string",
    "confirm_password": "string"
  }
  ```
  
- Валідації:
  - Перевірка поточного пароля (current_password)
  - Перевірка що new_password == confirm_password
  - Валідація нового пароля:
    - Мінімум 8 символів
    - Хоча б одна велика літера
    - Хоча б одна маленька літера
    - Хоча б одна цифра
  - Новий пароль не повинен збігатися з поточним
  
- Response:
  - 200 OK: { "message": "Пароль успішно змінено" }
  - 400 Bad Request: помилки валідації (неправильний формат пароля, паролі не співпадають)
  - 401 Unauthorized: поточний пароль невірний
  - 422 Unprocessable Entity: новий пароль співпадає з поточним
  
- Додатково:
  - Модифікація існуючого ендпоінту GET /api/auth/me (або GET /api/users/me):
    - Перевірити що він повертає всю необхідну інформацію про користувача
    - Додати поле last_password_change (якщо його немає в моделі User)
  
## Необхідні зміни API

### Новий ендпоінт:
**POST /api/auth/change-password**
- Headers: Authorization Bearer token
- Body: ChangePasswordRequest
- Response: ChangePasswordResponse або помилки

### Схеми Pydantic:
```python
class ChangePasswordRequest(BaseModel):
    current_password: str = Field(..., min_length=1)
    new_password: str = Field(..., min_length=8)
    confirm_password: str = Field(..., min_length=8)
    
class ChangePasswordResponse(BaseModel):
    message: str
    changed_at: datetime
```

### CRUD функції (app/crud.py):
```python
def verify_user_password(db: Session, user: User, password: str) -> bool:
    """Перевірити пароль користувача"""
    
def change_user_password(db: Session, user: User, new_password: str) -> User:
    """Змінити пароль користувача"""
```

## Вимоги/обмеження
- Доступно для всіх авторизованих користувачів (не тільки ADMIN)
- Обов'язкова перевірка поточного пароля
- Строга валідація нового пароля
- Хешування пароля через bcrypt (як і при створенні користувача)
- Логування спроб зміни пароля (успішних та неуспішних)
- Endpoint розміщено в auth router (/api/auth/change-password)

## Визначення готовності (DoD)
- ✅ Endpoint POST /api/auth/change-password реалізовано
- ✅ Перевірка поточного пароля працює
- ✅ Валідація нового пароля працює (мінімум 8 символів, велика/маленька літера, цифра)
- ✅ Перевірка що новий пароль не збігається з поточним
- ✅ Новий пароль коректно хешується та зберігається
- ✅ Користувач може увійти з новим паролем після зміни
- ✅ Помилка 401 при невірному поточному паролі
- ✅ Помилка 400 при невалідному новому паролі
- ✅ Endpoint задокументовано в OpenAPI/Swagger
- ✅ Написано юніт-тести

## Тести
- ✅ Успішна зміна пароля з коректним поточним паролем
- ✅ Помилка при невірному поточному паролі (401)
- ✅ Помилка якщо new_password != confirm_password (400)
- ✅ Помилка якщо новий пароль надто короткий (<8 символів) (400)
- ✅ Помилка якщо новий пароль без великої літери (400)
- ✅ Помилка якщо новий пароль без маленької літери (400)
- ✅ Помилка якщо новий пароль без цифри (400)
- ✅ Помилка якщо новий пароль збігається з поточним (422)
- ✅ Користувач може увійти з новим паролем
- ✅ Користувач не може увійти зі старим паролем після зміни
- ✅ OPERATOR може змінити свій пароль
- ✅ EXECUTOR може змінити свій пароль
- ✅ ADMIN може змінити свій пароль
- ✅ Неавторизований запит повертає 401

## Залежності
- BE-002 (аутентифікація, JWT)
- BE-001 (модель User)
- BE-012 (управління користувачами - для розуміння структури)

## Позначки
- Authentication, Password Management, User Profile, Security, Self-Service

## Додаткові нотатки
- Це окремий endpoint від адмінського reset-password
- reset-password (BE-012) - ADMIN генерує тимчасовий пароль для користувача
- change-password (BE-020) - користувач сам змінює свій пароль знаючи поточний
- В майбутньому можна додати email-повідомлення про зміну пароля
- В майбутньому можна додати історію зміни паролів
