# BE-016: Правила доступу та зміни статусів для виконавця (EXECUTOR)

Фаза: 1 (MVP)
Тип: Backend

## Мета
Реалізувати правила доступу для ролі EXECUTOR щодо перегляду звернень та зміни їх статусів з урахуванням відповідальності.

## Скоуп
- Визначення відповідального користувача:
  - Відповідальний – користувач, котрий змінив статус звернення на «В роботі»
  - Це може бути користувач з рівнем доступу ADMIN або EXECUTOR
  - Поле `assigned_to` (відповідальний) встановлюється автоматично при зміні статусу на "В роботі"

- Правила перегляду для EXECUTOR:
  - Виконавець бачить всі звернення зі статусом "Нове"
  - Виконавець бачить всі звернення, де він є відповідальним (assigned_to)
  - Виконавець НЕ бачить звернення інших виконавців (де assigned_to != поточний користувач)

- Правила зміни статусів для EXECUTOR:
  - Якщо звернення має статус "Нове" і відсутній відповідальний (assigned_to is NULL):
    - Виконавець може перевести звернення ЛИШЕ в статус "В роботі"
    - При зміні статусу на "В роботі" автоматично встановлюється assigned_to = поточний користувач
  - Якщо звернення має відповідального (assigned_to) і це поточний виконавець:
    - Виконавець може змінювати статус на будь-який дозволений (В роботі, Очікує відповіді, Вирішено, Закрито)
  - Якщо звернення має відповідального, але це інший користувач:
    - Виконавець НЕ може змінювати статус

## Необхідні зміни БД
- Додавання поля `assigned_to` (ForeignKey до User, nullable=True) в модель Case
- Індекс на поле `assigned_to` для оптимізації запитів фільтрації

## Вимоги/обмеження
- Фільтрація на рівні API endpoints для GET /cases
- Валідація прав при PATCH /cases/{public_id}/status
- Логування всіх змін відповідального та статусів
- При зміні статусу з "В роботі" на "Нове" - поле assigned_to обнуляється

## Визначення готовності (DoD)
- GET /cases для EXECUTOR повертає лише дозволені звернення (нові + де він відповідальний)
- PATCH /cases/{public_id}/status коректно валідує права виконавця
- При зміні статусу на "В роботі" автоматично встановлюється assigned_to
- Неможливо змінити статус чужого звернення
- З нового звернення виконавець може перейти лише в "В роботі"

## Тести
- EXECUTOR отримує список звернень (має бачити нові та свої)
- EXECUTOR змінює статус нового звернення на "В роботі" (assigned_to встановлюється)
- EXECUTOR намагається змінити статус нового звернення на інший (має бути 403)
- EXECUTOR змінює статус свого звернення (має працювати)
- EXECUTOR намагається змінити статус чужого звернення (має бути 403)
- EXECUTOR не бачить чужі звернення в списку
- ADMIN може змінювати будь-які статуси будь-яких звернень

## Залежності
- BE-003 (модель Case)
- BE-007 (управління статусами)
- BE-008 (RBAC permissions)

## Позначки
- RBAC, Permissions, Status, Executor, Access Control
