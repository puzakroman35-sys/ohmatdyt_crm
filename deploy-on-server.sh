#!/bin/bash
set -e

echo "=== Ohmatdyt CRM Production Deployment ==="
echo ""

# 1. ะะตัะตััะด ะฒ ะดะธัะตะบัะพััั ะฟัะพะตะบัั
echo "[1/8] ะะตัะตัะพะดะธะผะพ ะฒ ะดะธัะตะบัะพััั ะฟัะพะตะบัั..."
cd ~/ohmatdyt-crm
pwd

# 2. ะะตัะตะฒััะบะฐ ัะฐะนะปัะฒ
echo ""
echo "[2/8] ะะตัะตะฒััะบะฐ ะบะพะฝััะณััะฐััะนะฝะธั ัะฐะนะปัะฒ..."
ls -lh docker-compose.yml docker-compose.prod.yml .env

# 3. ะัะฟะธะฝะบะฐ ััะฐัะธั ะบะพะฝัะตะนะฝะตััะฒ
echo ""
echo "[3/8] ะัะฟะธะฝะบะฐ ััะฐัะธั ะบะพะฝัะตะนะฝะตััะฒ..."
docker compose -f docker-compose.yml -f docker-compose.prod.yml down 2>/dev/null || echo "ะะพะฝัะตะนะฝะตัะธ ะฝะต ะทะฐะฟััะตะฝั"

# 4. ะะฑััะบะฐ ะพะฑัะฐะทัะฒ
echo ""
echo "[4/8] ะะฑััะบะฐ Docker ะพะฑัะฐะทัะฒ (ัะต ะทะฐะนะผะต 5-10 ัะฒะธะปะธะฝ)..."
docker compose -f docker-compose.yml -f docker-compose.prod.yml build

# 5. ะะฐะฟััะบ ะบะพะฝัะตะนะฝะตััะฒ
echo ""
echo "[5/8] ะะฐะฟััะบ ะบะพะฝัะตะนะฝะตััะฒ..."
docker compose -f docker-compose.yml -f docker-compose.prod.yml up -d

# 6. ะััะบัะฒะฐะฝะฝั ะทะฐะฟััะบั
echo ""
echo "[6/8] ะััะบัะฒะฐะฝะฝั ะทะฐะฟััะบั ัะตัะฒัััะฒ (20 ัะตะบัะฝะด)..."
sleep 20

# 7. ะัะณัะฐััั ะะ
echo ""
echo "[7/8] ะะธะบะพะฝะฐะฝะฝั ะผัะณัะฐััะน ะฑะฐะทะธ ะดะฐะฝะธั..."
docker compose exec -T api alembic upgrade head || echo "ะะพะฟะตัะตะดะถะตะฝะฝั: ะผัะณัะฐััั ะผะพะถััั ะฟะพััะตะฑัะฒะฐัะธ ัััะฝะพั ะฟะตัะตะฒััะบะธ"

# 8. ะกัะฐััั
echo ""
echo "[8/8] ะกัะฐััั ะบะพะฝัะตะนะฝะตััะฒ:"
docker compose ps

echo ""
echo "=== ะะพะณะธ ัะตัะฒัััะฒ (ะพััะฐะฝะฝั 30 ััะดะบัะฒ) ==="
docker compose logs --tail=30

echo ""
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo "โ            ะะะะะะะขะะะะฏ ะะะะะะจะะะ ะฃะกะะะจะะ!                  โ"
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo ""
echo "๐ฑ Frontend:     http://192.168.31.248"
echo "๐ API Docs:     http://192.168.31.248/api/docs"
echo "๐ง API Direct:   http://192.168.31.248:8000"
echo ""
echo "ะะพัะธัะฝั ะบะพะผะฐะฝะดะธ:"
echo "  docker compose logs -f              # ะัั ะปะพะณะธ ะฒ ัะตะฐะปัะฝะพะผั ัะฐัั"
echo "  docker compose logs -f api          # ะะพะณะธ API"
echo "  docker compose logs -f frontend     # ะะพะณะธ Frontend"
echo "  docker compose ps                   # ะกัะฐััั ะบะพะฝัะตะนะฝะตััะฒ"
echo "  docker compose restart              # ะะตัะตะทะฐะฟััะบ"
echo "  docker compose down                 # ะัะฟะธะฝะบะฐ"
echo ""
