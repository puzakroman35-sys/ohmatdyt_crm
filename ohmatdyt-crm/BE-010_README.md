# BE-010: Зміна статусу кейсу (IN_PROGRESS -> NEEDS_INFO|REJECTED|DONE)

**Дата реалізації:** 28 жовтня 2025  
**Статус:** ✅ ЗАВЕРШЕНО

## Опис

Реалізовано функціонал зміни статусу кейсів відповідальним виконавцем з обов'язковим коментарем та автоматичними email-нотифікаціями.

## Основні компоненти

### 1. API Endpoint
**POST /api/cases/{case_id}/status**

Дозволяє відповідальному виконавцю змінити статус кейсу.

**Тіло запиту:**
```json
{
  "to_status": "DONE",
  "comment": "Звернення успішно опрацьовано"
}
```

**Відповідь (200 OK):**
```json
{
  "id": "uuid",
  "public_id": 123456,
  "status": "DONE",
  "responsible_id": "executor_uuid",
  ...
}
```

### 2. Валідні переходи статусів

**З IN_PROGRESS:**
- IN_PROGRESS -> IN_PROGRESS (додати коментар)
- IN_PROGRESS -> NEEDS_INFO (потрібна додаткова інформація)
- IN_PROGRESS -> REJECTED (звернення відхилено)
- IN_PROGRESS -> DONE (звернення виконано)

**З NEEDS_INFO:**
- NEEDS_INFO -> IN_PROGRESS (продовжити роботу після отримання інформації)
- NEEDS_INFO -> REJECTED (звернення відхилено)
- NEEDS_INFO -> DONE (звернення виконано)

**Заблоковані переходи:**
- Кейси зі статусом DONE або REJECTED не можуть бути змінені
- З NEW неможливо перейти напряму в фінальні статуси (потрібно спочатку взяти в роботу)

### 3. Бізнес-правила

1. **Обов'язковий коментар**
   - Мінімум 10 символів
   - Максимум 2000 символів
   - Зберігається як internal comment (видимий тільки виконавцям/адміну)

2. **Доступ**
   - Тільки відповідальний виконавець може змінювати статус
   - OPERATOR не може змінювати статус
   - Неві��повідальний executor отримує 403 Forbidden

3. **Історія змін**
   - Кожна зміна статусу логується в status_history
   - Зберігається: old_status, new_status, changed_by, changed_at
   - Повний audit trail для комплаєнсу

4. **Email-нотифікації**
   - Автор кейсу (OPERATOR) отримує email при зміні статусу
   - Нотифікація містить: номер кейсу, новий статус, ім'я виконавця, коментар
   - Асинхронна обробка через Celery (не блокує API)

### 4. CRUD функція

**change_case_status()** - основна бізнес-логіка

Валідація:
- Кейс існує
- Користувач є відповідальним виконавцем
- Перехід статусу дозволений
- Коментар валідний (не менше 10 символів)

Операції:
- Оновлення статусу кейсу
- Створення запису в status_history
- Створення internal comment
- Повернення оновленого кейсу

### 5. Celery задача

**send_case_status_changed_notification**

Параметри:
- case_id: UUID кейсу
- case_public_id: 6-значний номер
- new_status: Новий статус
- executor_id: UUID виконавця
- author_id: UUID автора
- comment: Коментар зі зміною

Функції:
- Отримання деталей виконавця та автора з БД
- Переклад статусу українською (DONE -> "Виконано")
- Відправка email (placeholder, повна реалізація в BE-014)
- Retry механізм з експоненційним backoff

## Тестування

**Файл:** `api/test_be010.py`

**Покриття:**
1. ✅ Створення тестових користувачів (operator, executor1, executor2)
2. ✅ Створення тестових даних (category, channel)
3. ✅ Створення кейсу як operator
4. ✅ Executor1 бере кейс в роботу (NEW -> IN_PROGRESS)
5. ✅ Зміна статусу на NEEDS_INFO
6. ✅ Зміна статусу назад на IN_PROGRESS
7. ✅ Зміна статусу на DONE
8. ✅ Спроба змінити DONE кейс (відхилено - 400)
9. ✅ Перевірка історії статусів
10. ✅ Валідація обов'язкового коментаря
11. ✅ RBAC: Невідповідальний executor не може змінити (403)
12. ✅ RBAC: Operator не може змінити (403)
13. ✅ Зміна статусу на REJECTED
14. ✅ Спроба змінити REJECTED кейс (відхилено - 400)

**Запуск тесту:**
```bash
cd api
$env:PYTHONIOENCODING="utf-8"
python test_be010.py
```

## Приклади використання

### Приклад 1: Запит додаткової інформації
```bash
POST /api/cases/{case_id}/status
Authorization: Bearer {executor_token}

{
  "to_status": "NEEDS_INFO",
  "comment": "Потрібні копії паспорта та довідки з місця проживання"
}
```

### Приклад 2: Завершення кейсу
```bash
POST /api/cases/{case_id}/status
Authorization: Bearer {executor_token}

{
  "to_status": "DONE",
  "comment": "Звернення опрацьовано, надано консультацію та направлення"
}
```

### Приклад 3: Відхилення кейсу
```bash
POST /api/cases/{case_id}/status
Authorization: Bearer {executor_token}

{
  "to_status": "REJECTED",
  "comment": "Звернення не відноситься до компетенції установи"
}
```

### Приклад 4: Продовження роботи після отримання інформації
```bash
POST /api/cases/{case_id}/status
Authorization: Bearer {executor_token}

{
  "to_status": "IN_PROGRESS",
  "comment": "Отримано додаткові документи, продовжуємо обробку"
}
```

## Коди помилок

- **200 OK** - Статус успішно змінено
- **400 Bad Request** - Невалідний перехід статусу або занадто короткий коментар
- **403 Forbidden** - Користувач не є відповідальним виконавцем
- **404 Not Found** - Кейс не знайдено
- **422 Unprocessable Entity** - Помилка валідації JSON

## Залежності

**Виконані:**
- ✅ BE-002: JWT Authentication
- ✅ BE-004: Cases Model & CRUD
- ✅ BE-006: Create Case endpoint
- ✅ BE-008: Status History model
- ✅ BE-009: Take Case endpoint

**Часткові:**
- ⚠️ BE-013: Celery/Redis (структура задач готова)
- ⚠️ BE-014: SMTP (placeholder, повна імплементація пізніше)

## Майбутні покращення

1. **Гнучкі переходи статусів**
   - Налаштування дозволених переходів адміністратором
   - Різні workflow для різних категорій
   - Користувацькі статуси

2. **Шаблони коментарів**
   - Готові шаблони для типових сценаріїв
   - Швидкі дії з попередньо заповненими коментарями
   - Бібліотека шаблонів

3. **Масова зміна статусів**
   - Зміна статусу для декількох кейсів одночасно
   - Спільний коментар для групи
   - Прогрес трекінг для масових операцій

4. **Затвердження змін статусу**
   - Вимога затвердження адміном для певних переходів
   - Двоетапне затвердження для пріоритетних кейсів
   - Налаштування workflow затвердження

5. **Розширені нотифікації**
   - In-app нотифікації разом з email
   - Push-нотифікації для мобільного додатку
   - SMS для термінових змін статусу
   - Персональні налаштування нотифікацій

6. **Аналітика статусів**
   - Середній час по кожному статусу
   - Патерни переходів статусів
   - Метрики продуктивності виконавців
   - Виявлення вузьких місць

## Переклад статусів

| Англійська | Українська |
|-----------|-----------|
| NEW | Новий |
| IN_PROGRESS | В роботі |
| NEEDS_INFO | Потрібна інформація |
| REJECTED | Відхилено |
| DONE | Виконано |

## Примітки

- Всі зміни статусів створюють і status history, і internal comment
- Internal comment видимий тільки виконавцям та адміну (не оператору)
- Email нотифікація включає український переклад статусу
- Status history забезпечує повний audit trail для комплаєнсу
- Celery задача має retry механізм для надійності
- Нотифікація не блокує відповідь API (асинхронна)

## Файли

**Створені/Змінені:**
1. `api/app/schemas.py` - CaseStatusChangeRequest schema
2. `api/app/crud.py` - change_case_status() function
3. `api/app/routers/cases.py` - POST /{case_id}/status endpoint
4. `api/app/celery_app.py` - send_case_status_changed_notification task
5. `api/test_be010.py` - Comprehensive test suite
6. `PROJECT_STATUS.md` - Detailed implementation documentation

## Автор

Реалізовано: GitHub Copilot  
Дата: 28 жовтня 2025
